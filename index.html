<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ê±âÂ†°ËØ≠ÂΩïÁîüÊàêÂô®</title>
    <link rel="icon" href="/icon.png" type="image/png">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #007AFF;
            --bg-color: #f5f5f7;
            --panel-bg: #ffffff;
            --footer-height: 50px;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
            margin: 0;
            min-height: 100vh;
            padding-bottom: calc(var(--footer-height) + 20px); 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: none; 
            overscroll-behavior: none;
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 500px;
            padding: 0 10px;
            margin-top: 20px;
            margin-bottom: 15px;
            box-sizing: border-box;
        }

        .brand-area { display: flex; align-items: center; gap: 10px; }
        .logo-img { width: 32px; height: 32px; object-fit: contain; display: block; }
        h3 { margin: 0; color: #333; font-size: 1.3rem; letter-spacing: 0.5px; }

        .nav-btn {
            text-decoration: none; background-color: #EBF3FF; color: var(--primary-color); padding: 8px 15px; border-radius: 20px; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 5px; transition: all 0.2s;
        }
        .nav-btn:active { background-color: #dbeaff; transform: scale(0.96); }


        .canvas-wrapper {
            margin: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #e1e1e1;
            background: #fff;
            max-width: 100%;
            overflow: hidden;
            border-radius: 4px;
            background-image: linear-gradient(45deg, #f0f0f0 25%, transparent 25%), linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #f0f0f0 75%), linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            position: relative; 
            
     
            touch-action: none;
        }


        .top-tools {
            display: flex; gap: 8px; padding: 10px 5px; flex-wrap: wrap; justify-content: center; width: 100%; background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.05); margin-bottom: 10px; position: sticky; top: 0; z-index: 50;
        }
        .divider { width: 1px; background: #ddd; height: 24px; margin: 0 5px; }

        .emoji-container { width: 100%; display: flex; justify-content: center; margin-top: 10px; }
        .emoji-bar { 
            display: flex; overflow-x: auto; gap: 12px; padding: 10px 15px; -webkit-overflow-scrolling: touch; scrollbar-width: none; max-width: 96%; background: #fff; border-radius: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .emoji-bar::-webkit-scrollbar { display: none; }
        .emoji-item { 
            font-size: 28px; cursor: pointer; transition: transform 0.1s; user-select: none; font-family: "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", "EmojiSymbols", sans-serif; min-width: 30px; text-align: center;
        }
        .emoji-item:active { transform: scale(1.3); }

     
        .prop-panel {
            position: fixed; bottom: 0; left: 0; width: 100%; background: var(--panel-bg); box-shadow: 0 -4px 20px rgba(0,0,0,0.15); padding: 20px 20px 30px 20px; border-radius: 20px 20px 0 0; display: none; flex-direction: column; gap: 15px; box-sizing: border-box; z-index: 100; transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); transform: translateY(100%);
        }
        .prop-panel.active { display: flex; transform: translateY(0); }

        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0; }

        .prop-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .prop-label { font-size: 14px; color: #555; font-weight: 600; width: 50px; flex-shrink: 0;}
        
        .font-select {
            flex-grow: 1; padding: 8px 12px; border-radius: 8px; border: 1px solid #ddd; background: #f9f9f9; font-size: 14px; color: #333; outline: none; -webkit-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 10px center; background-size: 16px;
        }

        input[type="color"] { border: none; width: 36px; height: 36px; padding: 0; background: none; border-radius: 50%; cursor: pointer; }
        input[type="range"] { flex-grow: 1; height: 4px; background: #ddd; border-radius: 2px; outline: none; -webkit-appearance: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #fff; border: 2px solid var(--primary-color); border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        .btn { background-color: var(--primary-color); color: white; border: none; padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; touch-action: manipulation; transition: all 0.2s; }
        .btn:active { transform: scale(0.96); }
        .btn.disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.6; }
        .btn-icon-only { padding: 8px; border-radius: 50%; width: 36px; height: 36px; justify-content: center; }
        .btn-green { background-color: #34c759; }
        .btn-red { background-color: #ff3b30; color: white !important; }
        .btn-outline { background-color: white; color: #333; border: 1px solid #ddd; }
        .btn-done { background-color: var(--primary-color); padding: 6px 20px; }

        .app-footer { position: absolute; bottom: 0; width: 100%; height: var(--footer-height); background-color: #e9e9eb; color: #888; display: flex; justify-content: center; align-items: center; font-size: 12px; border-top: 1px solid #d1d1d6; }
        .app-footer a { color: #666; text-decoration: none; margin: 0 5px; }

        #imgLoader { display: none; }
    </style>
</head>
<body>

    <div class="app-header">
        <div class="brand-area">
            <img src="icon.png" class="logo-img" alt="Logo" onerror="this.style.display='none'">
            <h3>Ê±âÂ†°ÁîüÊàêÂô®</h3>
        </div>
        <a href="quotes.html" class="nav-btn">ÊâæÁÅµÊÑü</a>
    </div>

    <div class="top-tools">
        <button id="btnUndo" class="btn btn-outline btn-icon-only disabled" onclick="undo()" title="Êí§ÈîÄ">‚Ü©Ô∏è</button>
        <button id="btnRedo" class="btn btn-outline btn-icon-only disabled" onclick="redo()" title="ÈáçÂÅö">‚Ü™Ô∏è</button>
        <div class="divider"></div>
        <label for="imgLoader" class="btn">‰∏ä‰º†ÂõæÁâá</label>
        <input type="file" id="imgLoader" accept="image/*">
        <button class="btn btn-outline" onclick="addText()">Ê∑ªÂä†ÊñáÂ≠ó</button>
        <button class="btn btn-green" onclick="downloadImage()">‰øùÂ≠ò</button>
        <button class="btn btn-outline" style="color: #ff3b30; border-color: #ff3b3033;" onclick="clearCanvas()">üóëÔ∏è</button>
    </div>

    <div class="canvas-wrapper">
        <canvas id="c"></canvas>
    </div>

    <div class="emoji-container">
        <div class="emoji-bar">
            <div class="emoji-item" onclick="addEmoji('üòÇ')">üòÇ</div>
            <div class="emoji-item" onclick="addEmoji('üòé')">üòé</div>
            <div class="emoji-item" onclick="addEmoji('üî•')">üî•</div>
            <div class="emoji-item" onclick="addEmoji('ü§î')">ü§î</div>
            <div class="emoji-item" onclick="addEmoji('üëç')">üëç</div>
            <div class="emoji-item" onclick="addEmoji('üò≠')">üò≠</div>
            <div class="emoji-item" onclick="addEmoji('üéâ')">üéâ</div>
            <div class="emoji-item" onclick="addEmoji('üëÄ')">üëÄ</div>
            <div class="emoji-item" onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</div>
            <div class="emoji-item" onclick="addEmoji('üçî')">üçî</div>
            <div class="emoji-item" onclick="addEmoji('ü§°')">ü§°</div>
            <div class="emoji-item" onclick="addEmoji('üí©')">üí©</div>
            <div class="emoji-item" onclick="addEmoji('üöÄ')">üöÄ</div>
            <div class="emoji-item" onclick="addEmoji('ü•™')">ü•™</div>
        </div>
    </div>

    <div class="prop-panel" id="propPanel">
        <div class="panel-header">
            <button class="btn btn-outline" style="color:#ff3b30; border-color:#eee; font-size:12px; padding:6px 12px;" onclick="deleteSelected()">üóëÔ∏è ÁßªÈô§</button>
            <span style="font-weight:bold; font-size:15px; color:#333;">Ê†∑ÂºèÁºñËæë</span>
            <button class="btn btn-done" onclick="finishEditing()">ÂÆåÊàê</button>
        </div>

        <div class="prop-row">
            <span class="prop-label">Â≠ó‰Ωì</span>
            <select id="fontFamily" class="font-select" onchange="updateStyle('fontFamily', this.value)">
                <option value="Poppins, sans-serif">ÈªòËÆ§</option>
                <option value="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif">Èªë‰Ωì</option>
                <option value="'Noto Serif SC', 'Songti SC', 'SimSun', 'Times New Roman', serif">ÂÆã‰Ωì</option>
                <option value="Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif">Meme Á≤ó‰Ωì</option>
                <option value="'Ma Shan Zheng', 'KaiTi', 'STKaiti', 'Brush Script MT', cursive">Ê•∑‰Ωì</option>
                <option value="'Courier New', Courier, monospace">‰ª£Á†Å‰ΩìÔºàEngÔºâ</option>
            </select>
        </div>

        <div class="prop-row">
            <span class="prop-label">Â≠óËâ≤</span>
            <input type="color" id="fillColor" onchange="updateStyle('fill', this.value)">
            <span style="font-size:12px; color:#999;">ÁÇπÂáªÂúÜÂúàÈÄâÊã©È¢úËâ≤</span>
        </div>
        <div class="prop-row">
            <span class="prop-label">ÊèèËæπ</span>
            <input type="color" id="strokeColor" value="#ffffff" onchange="updateStyle('stroke', this.value)">
            <input type="range" id="strokeWidth" min="0" max="8" step="0.5" value="0" oninput="updateStyle('strokeWidth', parseFloat(this.value))">
        </div>
        <div class="prop-row">
            <span class="prop-label">Èò¥ÂΩ±</span>
            <input type="color" id="shadowColor" value="#000000" onchange="updateShadow()">
            <input type="range" id="shadowBlur" min="0" max="25" step="1" value="0" oninput="updateShadow()">
        </div>
    </div>

    <footer class="app-footer">
¬© 2025 Zhoushudechang Team | <a href="https://space.bilibili.com/382046701">ÂØªÊâæÊ±âÂ†°</a> | <a href="https://www.bilibili.com/video/BV1GJ411x7h7">‰Ω†ÁåúÁåúËøô‰∏™ÊòØ‰ªÄ‰πà</a>
    </footer>

    <script>
        const initWidth = Math.min(window.innerWidth - 40, 500);
        const EMOJI_FONT_STACK = "'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji', 'EmojiSymbols', sans-serif";

        const canvas = new fabric.Canvas('c', {
            width: initWidth,
            height: initWidth,
            backgroundColor: 'transparent',
            preserveObjectStacking: true,
            selectionColor: 'rgba(0,122,255,0.1)',
            selectionBorderColor: '#007AFF',
            allowTouchScrolling: false, 
            fireRightClick: true,  
            stopContextMenu: true,
        });

        let currentBgImage = null;
        let history = [];
        let historyIndex = -1;
        let historyProcessing = false;

        canvas.on('touch:gesture', function(e) {
         
            const activeObj = canvas.getActiveObject();
            if (!activeObj) return;


            if (activeObj.name === 'bgImage' && activeObj.lockRotation) return;

            if (e.self.state === "start") {
                activeObj._startScale = activeObj.scaleX; 
                activeObj._startAngle = activeObj.angle;
            } 
            else if (e.self.state === "change") {

                const newScale = activeObj._startScale * e.self.scale;
                const newAngle = activeObj._startAngle + e.self.rotation;

                activeObj.set({
                    scaleX: newScale,
                    scaleY: newScale,
                    angle: newAngle
                });

                canvas.requestRenderAll();
            }
            else if (e.self.state === "end") {
                activeObj.setCoords(); 
                saveHistory();
            }
        });

        function addText() {
            const text = new fabric.IText('ÂèåÂáªÁºñËæë', {
                left: canvas.width / 2, top: canvas.height / 2, originX: 'center', originY: 'center',
                fontFamily: 'Poppins, sans-serif', fill: '#000000', fontSize: 40, fontWeight: 'bold',
                stroke: '#000000', strokeWidth: 1.5, paintFirst: 'stroke',
                shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.5)', blur: 10, offsetX: 2, offsetY: 2 }),
                editable: true 
            });
            canvas.add(text);
            canvas.setActiveObject(text);
        }


        function finishEditing() {
            if (canvas.getActiveObject() && canvas.getActiveObject().isEditing) {
                canvas.getActiveObject().exitEditing();
            }
            canvas.discardActiveObject();
            canvas.requestRenderAll();
        }

        canvas.on('mouse:down', function(e) {
            if (e.target && e.target.name === 'bgImage') {
                if (canvas.getActiveObject() && canvas.getActiveObject() !== e.target) {
                    canvas.discardActiveObject();
                    canvas.requestRenderAll();
                    return; 
                }
            }
        });

        function saveHistory() {
            if (historyProcessing) return;
            if (historyIndex < history.length - 1) history = history.slice(0, historyIndex + 1);
            history.push(JSON.stringify(canvas));
            historyIndex++;
            updateHistoryButtons();
        }

        function updateHistoryButtons() {
            document.getElementById('btnUndo').classList.toggle('disabled', historyIndex <= 0);
            document.getElementById('btnRedo').classList.toggle('disabled', historyIndex >= history.length - 1);
        }

        function undo() {
            if (historyIndex > 0) {
                historyProcessing = true;
                historyIndex--;
                canvas.loadFromJSON(history[historyIndex], () => {
                    canvas.renderAll();
                    rebindBgImage();
                    historyProcessing = false;
                    updateHistoryButtons();
                });
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                historyProcessing = true;
                historyIndex++;
                canvas.loadFromJSON(history[historyIndex], () => {
                    canvas.renderAll();
                    rebindBgImage();
                    historyProcessing = false;
                    updateHistoryButtons();
                });
            }
        }

        function rebindBgImage() {
            currentBgImage = canvas.getObjects().find(o => o.name === 'bgImage') || null;
        }

        canvas.on('object:added', () => !historyProcessing && saveHistory());
        canvas.on('object:modified', () => !historyProcessing && saveHistory());
        canvas.on('object:removed', () => !historyProcessing && saveHistory());
        saveHistory();

        fabric.Object.prototype.set({
            transparentCorners: false, cornerColor: '#ffffff', cornerStrokeColor: '#007AFF',
            borderColor: '#007AFF', cornerSize: 20, padding: 10, borderScaleFactor: 2, rotatingPointOffset: 20
        });

        document.getElementById('imgLoader').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const imgObj = new Image();
                imgObj.src = event.target.result;
                imgObj.onload = function() {
                    if (currentBgImage) canvas.remove(currentBgImage);
                    const imgInstance = new fabric.Image(imgObj);
                    const scale = (canvas.width / imgInstance.width);
                    imgInstance.set({
                        scaleX: scale, scaleY: scale,
                        left: canvas.width / 2, top: canvas.height / 2,
                        originX: 'center', originY: 'center',
                        selectable: true, name: 'bgImage'
                    });
                    canvas.setHeight(imgInstance.height * scale);
                    currentBgImage = imgInstance;
                    canvas.add(imgInstance);
                    canvas.sendToBack(imgInstance);
                    canvas.setActiveObject(imgInstance);
                }
            }
            reader.readAsDataURL(e.target.files[0]);
            e.target.value = '';
        });

        function keepBgAtBottom() { if (currentBgImage) canvas.sendToBack(currentBgImage); }
        canvas.on('object:modified', keepBgAtBottom);
        canvas.on('selection:created', keepBgAtBottom);

        function addEmoji(emoji) {
            const text = new fabric.IText(emoji, {
                left: canvas.width / 2, top: canvas.height / 2, originX: 'center', originY: 'center',
                fontSize: 70, fontFamily: EMOJI_FONT_STACK
            });
            canvas.add(text);
            canvas.setActiveObject(text);
        }

        function updateStyle(prop, value) {
            const activeObj = canvas.getActiveObject();
            if (activeObj && (activeObj.type === 'i-text' || activeObj.type === 'text')) {
                activeObj.set(prop, value);
                canvas.requestRenderAll();
                saveHistory();
            }
        }

        function updateShadow() {
            const activeObj = canvas.getActiveObject();
            if (activeObj && (activeObj.type === 'i-text' || activeObj.type === 'text')) {
                const color = document.getElementById('shadowColor').value;
                const blur = parseInt(document.getElementById('shadowBlur').value);
                if (blur === 0) activeObj.set('shadow', null);
                else {
                    const rgbaColor = hexToRgba(color, 0.6);
                    activeObj.set('shadow', new fabric.Shadow({
                        color: rgbaColor, blur: blur, offsetX: blur > 0 ? 3 : 0, offsetY: blur > 0 ? 3 : 0
                    }));
                }
                canvas.requestRenderAll();
                saveHistory();
            }
        }

        function hexToRgba(hex, alpha) {
            let r = parseInt(hex.slice(1, 3), 16),
                g = parseInt(hex.slice(3, 5), 16),
                b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function deleteSelected() {
            const activeObj = canvas.getActiveObject();
            if (activeObj) {
                if (activeObj === currentBgImage) currentBgImage = null;
                canvas.remove(activeObj);
                canvas.discardActiveObject();
                canvas.requestRenderAll();
            }
        }
        
        function clearCanvas() {
             if (confirm('Á°ÆÂÆöÊ∏ÖÁ©∫Ôºü')) {
                 canvas.clear();
                 currentBgImage = null;
                 canvas.setBackgroundColor('transparent', canvas.renderAll.bind(canvas));
                 saveHistory();
             }
        }

        function downloadImage() {
            finishEditing(); 
            const dataURL = canvas.toDataURL({ format: 'png', multiplier: 2 }); 
            const link = document.createElement('a');
            link.download = 'Ê±âÂ†°ËØ≠ÂΩï.png';
            link.href = dataURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const passedText = urlParams.get('text');

            if (passedText) {
                const text = new fabric.IText(passedText, {
                    left: canvas.width / 2, top: canvas.height / 2,
                    originX: 'center', originY: 'center',
                    fontFamily: 'Poppins, sans-serif',
                    fill: '#000000', fontSize: 40, fontWeight: 'bold', textAlign: 'center'
                });
                canvas.add(text);
                canvas.setActiveObject(text);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });

        const propPanel = document.getElementById('propPanel');
        canvas.on('selection:created', (e) => handleSelection(e.selected[0]));
        canvas.on('selection:updated', (e) => handleSelection(e.selected[0]));
        canvas.on('selection:cleared', () => { propPanel.classList.remove('active'); });

        function handleSelection(obj) {
            if (obj.type === 'i-text' || obj.type === 'text') {
                propPanel.classList.add('active');
                document.getElementById('fillColor').value = obj.fill || '#000000';
                document.getElementById('strokeColor').value = obj.stroke || '#ffffff';
                document.getElementById('strokeWidth').value = obj.strokeWidth || 0;
                document.getElementById('fontFamily').value = obj.fontFamily || 'Poppins, sans-serif';
                if (obj.shadow) {
                     document.getElementById('shadowColor').value = typeof obj.shadow.color === 'string' ? obj.shadow.color.substring(0,7) : '#000000';
                    document.getElementById('shadowBlur').value = obj.shadow.blur || 0;
                } else {
                    document.getElementById('shadowBlur').value = 0;
                }
            } else {
                propPanel.classList.remove('active');
            }
        }
    </script>
</body>
</html>